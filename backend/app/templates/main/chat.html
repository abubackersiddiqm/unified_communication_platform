<!-- -----------------------------------------------------------------------------
Project: Unified Communication Platform
Author: Abubacker Siddiq M
Copyright (c) 2025 Abubacker Siddiq M
License: MIT License (See LICENSE file for details)
------------------------------------------------------------------------------- -->

{% extends "base.html" %}

{% block title %}Chat - UCP{% endblock %}

{% block page_title %}Chat{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat List -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Chats</h6>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="showSMSModal()">
                        <i class="fas fa-sms"></i> SMS
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="showNewChatModal()">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
            </div>
            <div class="card-body chat-container">
                {% if chats %}
                    <div class="list-group list-group-flush">
                        {% for chat in chats %}
                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="openChat({{ chat.id }})">
                            <div>
                                <div class="fw-bold">
                                    {% if chat.chat_type == 'direct' %}
                                        {% for participant in chat.participants %}
                                            {% if participant.id != current_user.id %}
                                                {{ participant.full_name }}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {{ chat.name or 'Group Chat' }}
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ chat.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                            </div>
                            <span class="badge bg-primary">{{ chat.messages|length }}</span>
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">No chats yet</p>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Chat Window -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary" id="chatTitle">Select a chat</h6>
                <div id="chatActions"></div>
            </div>
            <div class="card-body chat-container" id="chatMessages">
                <p class="text-muted text-center">Select a chat to start messaging</p>
            </div>
            <div class="card-footer">
                <form id="messageForm" class="d-flex" onsubmit="sendMessage(event)">
                    <input type="text" id="messageInput" class="form-control me-2" placeholder="Type a message..." autocomplete="off" disabled>
                    <button class="btn btn-primary" type="submit" disabled><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start New Chat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userSelect" class="form-label">Select User(s)</label>
                    <select id="userSelect" class="form-select" multiple>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.full_name }} ({{ user.username }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="chatName" class="form-label">Group Name (optional)</label>
                    <input type="text" id="chatName" class="form-control" placeholder="Enter group name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createChat()">Create Chat</button>
            </div>
        </div>
    </div>
</div>

<!-- SMS Modal -->
<div class="modal fade" id="smsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send SMS</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="smsPhoneNumber" class="form-label">Phone Number *</label>
                    <input type="tel" id="smsPhoneNumber" class="form-control" placeholder="Enter phone number" required>
                </div>
                <div class="mb-3">
                    <label for="smsMessage" class="form-label">Message *</label>
                    <textarea id="smsMessage" class="form-control" rows="4" placeholder="Type your message..." required></textarea>
                    <small class="text-muted">Character count: <span id="charCount">0</span>/160</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="sendSMS()">
                    <span class="loading-spinner" id="smsSpinner" style="display: none;"></span>
                    <span id="smsButtonText">Send SMS</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentChatId = null;

// Check if there's a prefill number from contacts
document.addEventListener('DOMContentLoaded', function() {
    const prefillNumber = '{{ prefill_number }}';
    if (prefillNumber) {
        showSMSModal();
        document.getElementById('smsPhoneNumber').value = prefillNumber;
    }
});

function showNewChatModal() {
    const modal = new bootstrap.Modal(document.getElementById('newChatModal'));
    modal.show();
}

function showSMSModal() {
    const modal = new bootstrap.Modal(document.getElementById('smsModal'));
    modal.show();
}

function createChat() {
    const userSelect = document.getElementById('userSelect');
    const selected = Array.from(userSelect.selectedOptions).map(opt => parseInt(opt.value));
    const chatName = document.getElementById('chatName').value;
    if (selected.length === 0) {
        toast.error('Please select at least one user');
        return;
    }
    fetch('/api/create-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ participant_ids: selected, chat_type: selected.length > 1 ? 'group' : 'direct', name: chatName })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            toast.error('Error creating chat');
        }
    });
}

function sendSMS() {
    const phoneNumber = document.getElementById('smsPhoneNumber').value.trim();
    const message = document.getElementById('smsMessage').value.trim();
    
    if (!phoneNumber || !message) {
        toast.error('Please enter both phone number and message');
        return;
    }
    
    const spinner = document.getElementById('smsSpinner');
    const buttonText = document.getElementById('smsButtonText');
    spinner.style.display = 'inline-block';
    buttonText.style.display = 'none';
    
    fetch('/api/send-sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone_number: phoneNumber, message: message })
    })
    .then(res => res.json())
    .then(data => {
        spinner.style.display = 'none';
        buttonText.style.display = 'inline';
        if (data.success) {
            toast.success('SMS sent successfully');
            bootstrap.Modal.getInstance(document.getElementById('smsModal')).hide();
            document.getElementById('smsMessage').value = '';
        } else {
            toast.error('Error sending SMS: ' + data.error);
        }
    })
    .catch(error => {
        spinner.style.display = 'none';
        buttonText.style.display = 'inline';
        console.error('Error:', error);
        toast.error('Error sending SMS');
    });
}

function openChat(chatId) {
    console.log('Opening chat:', chatId);
    currentChatId = chatId;
    document.getElementById('messageInput').disabled = false;
    document.querySelector('#messageForm button').disabled = false;
    
    fetch(`/api/chats/${chatId}/messages`)
        .then(res => {
            console.log('Chat messages response status:', res.status);
            return res.json();
        })
        .then(messages => {
            console.log('Chat messages:', messages);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (!Array.isArray(messages) || messages.length === 0) {
                chatMessages.innerHTML = '<p class="text-muted text-center">No messages yet</p>';
            } else {
                const currentUserId = {{ current_user.id }};
                messages.forEach(msg => {
                    const align = msg.sender.id === currentUserId ? 'text-end' : 'text-start';
                    const badgeClass = align === 'text-end' ? 'primary' : 'secondary';
                    chatMessages.innerHTML += `
                        <div class="mb-2 ${align}">
                            <span class="badge bg-${badgeClass}">${msg.sender.name}</span>
                            <div class="d-inline-block ms-2">${msg.content}</div>
                            <div class="small text-muted">${msg.created_at}</div>
                        </div>
                    `;
                });
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            document.getElementById('chatTitle').textContent = 'Chat';
        })
        .catch(error => {
            console.error('Error loading chat messages:', error);
            document.getElementById('chatMessages').innerHTML = '<p class="text-danger text-center">Error loading messages</p>';
        });
}

function sendMessage(event) {
    event.preventDefault();
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content || !currentChatId) {
        console.log('No content or chat ID');
        return;
    }
    
    console.log('Sending message:', content, 'to chat:', currentChatId);
    
    fetch('/api/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: currentChatId, content })
    })
    .then(res => {
        console.log('Send message response status:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('Send message response:', data);
        if (data.success) {
            openChat(currentChatId);
            input.value = '';
        } else {
            toast.error('Error sending message: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        toast.error('Error sending message');
    });
}

// Character count for SMS
document.getElementById('smsMessage').addEventListener('input', function() {
    const count = this.value.length;
    document.getElementById('charCount').textContent = count;
    if (count > 160) {
        document.getElementById('charCount').style.color = 'red';
    } else {
        document.getElementById('charCount').style.color = '';
    }
});
</script>
{% endblock %} 